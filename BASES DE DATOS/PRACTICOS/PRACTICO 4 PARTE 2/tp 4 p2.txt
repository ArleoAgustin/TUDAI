--TP 4 PARTE 2--
--Ejercicio 1.1--
SELECT p.titulo
FROM unc_esq_peliculas.pelicula p,
     unc_esq_peliculas.entrega e,
     unc_esq_peliculas.renglon_entrega r
WHERE p.codigo_pelicula = r.codigo_pelicula
AND r.nro_entrega = e.nro_entrega
AND p.idioma LIKE 'Inglés' AND
    extract(YEAR FROM e.fecha_entrega) > 2006;
--Ejercicio 1.2--
SELECT count(*)
FROM unc_esq_peliculas.renglon_entrega r,
     unc_esq_peliculas.distribuidor d,
     unc_esq_peliculas.entrega e
WHERE r.nro_entrega = e.nro_entrega
AND e.id_distribuidor = d.id_distribuidor
AND d.tipo = 'N'
AND extract(YEAR FROM e.fecha_entrega) = 2006;
SELECT count(*)
FROM unc_esq_peliculas.pelicula p
WHERE p.codigo_pelicula IN (
    SELECT r.codigo_pelicula
    FROM unc_esq_peliculas.renglon_entrega r
    WHERE r.nro_entrega IN (
        SELECT e.nro_entrega
        FROM unc_esq_peliculas.entrega e
        WHERE (extract (YEAR FROM fecha_entrega) = 2006)
        AND e.id_distribuidor IN (
             SELECT d.id_distribuidor
             FROM unc_esq_peliculas.distribuidor d
             WHERE tipo = 'N')
        )
    );
--Ejercicio 1.3--
SELECT *
FROM unc_esq_peliculas.departamento
WHERE (id_distribuidor, id_departamento) NOT IN
   (SELECT id_distribuidor, id_departamento
   FROM unc_esq_peliculas.empleado e, unc_esq_peliculas.tarea t
   WHERE e.id_tarea = t.id_tarea
   AND  (sueldo_maximo - sueldo_minimo) <= sueldo_maximo*0.1);
SELECT *
FROM unc_esq_peliculas.departamento
WHERE (id_distribuidor, id_departamento) NOT IN
   (SELECT id_distribuidor, id_departamento
   FROM unc_esq_peliculas.empleado e
   WHERE e.id_tarea IN(
       SELECT t.id_tarea
       FROM unc_esq_peliculas.tarea t
       WHERE (t.sueldo_maximo - t.sueldo_minimo) <= t.sueldo_maximo*0.4)
);
--Ejercicio 1.4--
SELECT *
FROM unc_esq_peliculas.pelicula p
WHERE p.codigo_pelicula IN(
    SELECT r.codigo_pelicula
    FROM unc_esq_peliculas.renglon_entrega r
    WHERE r.nro_entrega IN (
        SELECT e.nro_entrega
        FROM unc_esq_peliculas.entrega e
        WHERE e.id_distribuidor NOT IN (
            SELECT d.id_distribuidor
            FROM unc_esq_peliculas.distribuidor d
            WHERE d.tipo = 'N'
        )
    )
);
SELECT *
FROM unc_esq_peliculas.pelicula p,
     unc_esq_peliculas.renglon_entrega r,
     unc_esq_peliculas.distribuidor d,
     unc_esq_peliculas.entrega e
WHERE p.codigo_pelicula = r.codigo_pelicula
AND e.nro_entrega = r.nro_entrega
AND e.id_distribuidor = d.id_distribuidor
AND d.tipo = 'I';
--Ejericio 1.5--
SELECT *
FROM unc_esq_peliculas.empleado j
WHERE EXISTS(
    SELECT e.id_jefe
    FROM unc_esq_peliculas.empleado e
    WHERE e.id_jefe = j.id_empleado)
AND (j.id_departamento, j.id_distribuidor) IN (
    SELECT d.id_departamento, d.id_distribuidor
    FROM unc_esq_peliculas.departamento d
    WHERE d.id_ciudad IN (
        SELECT c.id_ciudad
        FROM unc_esq_peliculas.ciudad c
        WHERE c.id_pais IN (
            SELECT p.id_pais
            FROM unc_esq_peliculas.pais p
            WHERE nombre_pais = 'ARGENTINA'
        )
    )
)
ORDER BY j.id_jefe;
--Ejercicio 1.6--
SELECT e.nombre, e.apellido
FROM unc_esq_peliculas.empleado e
WHERE e.id_jefe IN (
    SELECT e2.id_jefe
    FROM unc_esq_peliculas.empleado e2
    WHERE e2.porc_comision > 10
      AND e2.id_empleado IN (
        SELECT e3.id_empleado
        FROM unc_esq_peliculas.empleado e3
        WHERE e3.id_jefe IN (
            SELECT d.jefe_departamento
            FROM unc_esq_peliculas.departamento d
            WHERE d.id_ciudad IN (
                SELECT c.id_ciudad
                FROM unc_esq_peliculas.ciudad c
                WHERE c.id_pais IN (
                    SELECT p.id_pais
                    FROM unc_esq_peliculas.pais p
                    WHERE (nombre_pais = 'ARGENTINA')
                )
            )
        )
    )
);
--Ejercicio 1.7--
SELECT p.genero, sum(cantidad),count(*)
FROM unc_esq_peliculas.pelicula p
    JOIN unc_esq_peliculas.renglon_entrega r
        ON p.codigo_pelicula = r.codigo_pelicula
    JOIN unc_esq_peliculas.entrega e ON r.nro_entrega = e.nro_entrega
WHERE extract(YEAR FROM e.fecha_entrega) >= 2010
GROUP BY p.genero;
SELECT p.genero, sum(r.cantidad), count(*)
FROM unc_esq_peliculas.entrega e,
     unc_esq_peliculas.renglon_entrega r,
     unc_esq_peliculas.pelicula p
WHERE e.nro_entrega=r.nro_entrega
  AND r.codigo_pelicula=p.codigo_pelicula
  AND extract(YEAR FROM fecha_entrega)>=2010
GROUP BY p.genero;
--Ejercicio 1.8--
SELECT fecha_entrega, v.propietario, r.cantidad
FROM unc_esq_peliculas.video v, unc_esq_peliculas.entrega e,
     unc_esq_peliculas.renglon_entrega r
WHERE v.id_video = e.id_video AND e.nro_entrega = r.nro_entrega
GROUP BY fecha_entrega, v.propietario, r.cantidad
ORDER BY fecha_entrega;
SELECT extract(DAY FROM fecha_entrega) AS "dia", v.propietario, r.cantidad
FROM unc_esq_peliculas.video v JOIN unc_esq_peliculas.entrega e
        ON(v.id_video = e.id_video)
     JOIN unc_esq_peliculas.renglon_entrega r ON(e.nro_entrega = r.nro_entrega)
GROUP BY extract(DAY FROM fecha_entrega), v.propietario, r.cantidad
ORDER BY extract(DAY FROM fecha_entrega);
--Ejercicio 1.9--
SELECT c.nombre_ciudad, count(e.id_empleado) AS "total"
FROM unc_esq_peliculas.ciudad c, unc_esq_peliculas.departamento d,
     unc_esq_peliculas.empleado e
WHERE c.id_ciudad = d.id_ciudad AND
      d.id_departamento = e.id_departamento AND
      d.id_distribuidor = e.id_distribuidor AND
      AGE(fecha_nacimiento) >= '18 years'
GROUP BY c.nombre_ciudad
HAVING count(e.id_empleado) > 30;
SELECT nombre_ciudad, COUNT(id_empleado)
FROM unc_esq_peliculas.ciudad c
    JOIN unc_esq_peliculas.departamento d
        ON (c.id_ciudad = d.id_ciudad)
    JOIN unc_esq_peliculas.empleado e
        ON (d.id_departamento = e.id_departamento
                AND d.id_distribuidor = e.id_distribuidor)
WHERE AGE(fecha_nacimiento) >= '18 years'
GROUP BY nombre_ciudad
HAVING COUNT(id_empleado) > 30;
--Ejercicio 2.1--
SELECT i.nombre_institucion, count(nro_voluntario) AS "total"
FROM unc_esq_voluntario.institucion i JOIN  unc_esq_voluntario.voluntario v
    ON(i.id_institucion = v.id_institucion)
WHERE v.horas_aportadas > 0.0
GROUP BY i.nombre_institucion
ORDER BY nombre_institucion;
--Ejercicio 2.2--
SELECT count(v.id_coordinador) AS "Número de coordinadores",
       p.nombre_pais, c.nombre_continente
FROM unc_esq_voluntario.continente c
    JOIN unc_esq_voluntario.pais p
        ON (c.id_continente = p.id_continente)
    JOIN unc_esq_voluntario.direccion d
        ON (p.id_pais = d.id_pais)
    JOIN unc_esq_voluntario.institucion i
        ON (d.id_direccion = i.id_direccion)
    JOIN unc_esq_voluntario.voluntario v
        ON(i.id_institucion = v.id_institucion)
GROUP BY p.nombre_pais, c.nombre_continente;
SELECT count(v.id_coordinador) AS "Número de coordinadores",
       p.nombre_pais, c.nombre_continente
FROM unc_esq_voluntario.voluntario v
    JOIN unc_esq_voluntario.institucion i
        ON(v.id_institucion = i.id_institucion)
    JOIN unc_esq_voluntario.direccion d
        ON(i.id_direccion = d.id_direccion)
    JOIN unc_esq_voluntario.pais p
        ON(d.id_pais = p.id_pais)
    JOIN unc_esq_voluntario.continente c
        ON(p.id_continente = c.id_continente)
GROUP BY p.nombre_pais, c.nombre_continente;
--Ejercicio 2.3--
SELECT v.nombre, v.apellido, v.fecha_nacimiento
FROM unc_esq_voluntario.voluntario v
    JOIN unc_esq_voluntario.institucion i ON(
    v.id_institucion = i.id_institucion
    )
WHERE i.id_institucion = (
     SELECT v2.id_institucion
     FROM unc_esq_voluntario.voluntario v2
     WHERE v2.apellido LIKE 'Zlotkey'
    ) AND v.apellido NOT LIKE 'Zlotkey';
--Ejercicio 2.4--
SELECT apellido, nro_voluntario, horas_aportadas
FROM unc_esq_voluntario.voluntario
GROUP BY apellido, nro_voluntario, horas_aportadas
HAVING horas_aportadas > avg(horas_aportadas)
ORDER BY horas_aportadas;